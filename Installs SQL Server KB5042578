
<#
.SYNOPSIS
  Installs SQL Server KB5042578 (or relevant KB) for remediation
  For MECM/Intune deployment
#>

$KBID = "5042578"
$DownloadURL = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/updt/2024/09/sqlserver2022-kb5042578-x64_d4e3d93b.msu"
$LocalPath = "$env:TEMP\SQLServer_$KBID.msu"
$LogFile = "C:\Windows\Temp\SQLServer_KB$KBID.log"

Write-Output "Checking if KB$KBID is already installed..."
if (Get-HotFix -Id "KB$KBID" -ErrorAction SilentlyContinue) {
    Write-Output "KB$KBID already installed."
    exit 0
}

Write-Output "Downloading KB$KBID..."
Invoke-WebRequest -Uri $DownloadURL -OutFile $LocalPath

Write-Output "Installing KB$KBID..."
Start-Process "wusa.exe" -ArgumentList "`"$LocalPath`" /quiet /norestart /log:$LogFile" -Wait

# Verify install
Start-Sleep -Seconds 30
if (Get-HotFix -Id "KB$KBID" -ErrorAction SilentlyContinue) {
    Write-Output "KB$KBID installed successfully."
    exit 0
} else {
    Write-Output "KB$KBID installation failed."
    exit 1
}

